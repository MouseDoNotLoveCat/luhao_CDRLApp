# 🔍 导入部分失败诊断指南

## 问题描述

- **预期**：导入 84 个问题
- **实际**：只导入了 27 个问题
- **症状**：导入结果界面显示 `imported_issues_count: 27`

## 可能的原因

### 1. 问题数据不完整
某些问题可能缺少必需的字段（如 `description`），导致插入失败。

### 2. 标段匹配或创建失败
`_insert_issue` 方法中的标段匹配或创建过程可能失败，导致 `section_id` 为 `None`。

### 3. 分类器异常
`IssueCategoryClassifier.classify()` 可能抛出异常，导致整个问题插入失败。

### 4. 数据库约束冲突
某些问题可能违反数据库约束（如唯一性约束），导致插入失败。

## 诊断步骤

### 步骤 1：启动应用并查看后端日志

```bash
./start-dev.sh
```

### 步骤 2：重新测试导入流程

1. 上传 Word 文档
2. 在"已识别的问题"界面选择全部 84 个问题
3. 点击"下一步"
4. 点击"确认导入"

### 步骤 3：查看后端控制台输出

后端会输出详细的日志信息：

```
📋 开始导入选中的问题
   选中的问题 ID 列表: ['temp_0', 'temp_1', ..., 'temp_83']
   选中的问题数量: 84
   通知书中的总问题数: 84
   ✓ 导入问题 0: temp_0
   ✓ 导入问题 1: temp_1
   ...
   ✗ 问题 27 (temp_27) 插入失败
   ...

📊 导入统计:
   成功导入: 27 个
   导入失败: 57 个
   跳过未选中: 0 个
```

### 步骤 4：查看失败问题的详细错误信息

后端会输出每个失败问题的详细信息：

```
❌ 插入隐患问题失败: [错误信息]
   问题数据: {...}
   通知书 ID: 1, 项目 ID: 1
Traceback (most recent call last):
  ...
```

## 改进的日志记录

### 前端日志
- 发送的 `selected_issue_ids` 数组
- API 响应中的 `imported_issues_count`
- API 响应中的 `failed_issues` 列表（如果有）

### 后端日志
- 选中的问题 ID 列表
- 每个问题的导入状态（成功/失败）
- 失败问题的详细错误信息
- 导入统计摘要

## 下一步

根据后端日志中的错误信息，我们可以：

1. **如果是数据不完整**：修复 Word 解析器或数据验证逻辑
2. **如果是标段匹配失败**：改进标段匹配算法
3. **如果是分类器异常**：添加异常处理或改进分类器
4. **如果是数据库约束**：检查数据库模式或添加冲突处理

---

**诊断状态**：⏳ **等待用户运行测试并提供后端日志**

