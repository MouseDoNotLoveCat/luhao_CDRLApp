# 问题类别导入错误 - 测试指南

## 🧪 测试目标

验证用户在编辑界面修改的问题类别能正确保存到数据库，不被默认值覆盖。

## 📋 测试前准备

### 1. 启动应用
```bash
cd /Users/haolu/Library/CloudStorage/OneDrive-个人/进行中的工作/工程监督/AppDev/CDRLApp
./start-dev.sh
```

### 2. 访问应用
- 前端：http://localhost:3000
- 后端 API：http://localhost:8000

### 3. 准备测试数据
- 使用 `Samples/黄百铁路内部监督通知书2025-08号.docx` 或其他包含多个问题的 Word 文档

## 🔍 测试步骤

### 步骤 1：上传文档
1. 进入导入页面
2. 点击"选择文件"
3. 选择 Word 文档
4. 点击"开始识别"

### 步骤 2：预览问题
1. 等待识别完成
2. 查看识别出的问题列表
3. 记录原始的问题类别

### 步骤 3：进入编辑界面
1. 点击"✏️ 编辑问题"按钮
2. 进入编辑界面

### 步骤 4：修改问题类别

**修改问题 1**：
- 找到第一个问题
- 修改一级分类：选择"工程质量"
- 修改二级分类：选择"隧道工程"
- 修改三级分类：选择"洞口开挖"

**修改问题 2**：
- 找到第二个问题
- 修改一级分类：选择"管理行为"
- 修改二级分类：选择"设计单位"
- 修改三级分类：选择"管理体系"

### 步骤 5：保存修改
1. 点击"保存修改"按钮
2. 返回问题预览界面

### 步骤 6：选择问题
1. 选择修改过的问题（至少选择 2 个）
2. 点击"下一步"

### 步骤 7：导入数据库
1. 进入确认界面
2. 点击"保存到数据库"
3. 等待导入完成

## ✅ 验证结果

### 方法 1：查看后端日志
```bash
# 查看后端日志中的问题类别来源
tail -f /tmp/backend.log | grep -E "问题类别来源|issue_category|issue_type_level"
```

**预期日志输出**：
```
[DEBUG] 问题类别来源: 用户编辑
[DEBUG] issue_category: 工程质量
[DEBUG] issue_type_level1: 隧道工程
[DEBUG] issue_type_level2: 洞口开挖
```

### 方法 2：查看数据库
```bash
# 查询导入的问题
sqlite3 backend/cdrl.db << EOF
SELECT 
  issue_number,
  issue_category,
  issue_type_level1,
  issue_type_level2,
  description
FROM issues
ORDER BY id DESC
LIMIT 5;
EOF
```

**预期结果**：
- `issue_category` 应该是用户编辑的值（工程质量、管理行为等）
- `issue_type_level1` 应该是用户编辑的值（隧道工程、设计单位等）
- `issue_type_level2` 应该是用户编辑的值（洞口开挖、管理体系等）
- **不应该**都是"施工安全"

### 方法 3：前端验证
1. 导入完成后，查看导入结果
2. 点击"查看问题库"
3. 搜索导入的问题
4. 验证问题类别是否正确

## 🐛 常见问题

### Q1：导入后问题类别仍然是"施工安全"
**原因**：修改可能没有生效
**解决**：
1. 检查后端日志中的"问题类别来源"
2. 如果显示"自动分类"，说明前端没有传递用户编辑的值
3. 检查浏览器控制台是否有错误

### Q2：导入失败
**原因**：可能是数据格式问题
**解决**：
1. 查看后端日志中的错误信息
2. 检查问题数据是否完整
3. 尝试重新上传文档

### Q3：看不到编辑界面
**原因**：可能是前端没有正确加载
**解决**：
1. 刷新浏览器
2. 检查浏览器控制台是否有错误
3. 检查前端应用是否正常运行

## 📊 测试检查清单

- [ ] 应用正常启动
- [ ] 能上传 Word 文档
- [ ] 能识别问题
- [ ] 能进入编辑界面
- [ ] 能修改问题类别
- [ ] 能保存修改
- [ ] 能选择问题
- [ ] 能导入数据库
- [ ] 后端日志显示"用户编辑"
- [ ] 数据库中的问题类别正确
- [ ] 问题类别不是默认值"施工安全"

## 🎯 成功标准

✅ **测试通过**：
- 用户编辑的问题类别正确保存到数据库
- 三层问题分类都能正确保存
- 后端日志显示"问题类别来源: 用户编辑"
- 数据库中的数据与用户编辑的值一致

❌ **测试失败**：
- 问题类别被默认值覆盖
- 三层分类中有空值
- 后端日志显示"问题类别来源: 自动分类"
- 数据库中的数据与用户编辑的值不一致

---

**测试版本**：1.0
**最后更新**：2025-11-15

